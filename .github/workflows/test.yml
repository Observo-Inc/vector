name: Test Suite

on:
  pull_request_review:
    types: [submitted]
  push:
    branches:
      - master
      - pre_merge
  workflow_dispatch:

env:
  RUST_BACKTRACE: full
  TEST_LOG: vector=debug
  PROFILE: debug
  VERBOSE: true
  CI: true
  DISABLE_MOLD: true
  DEBIAN_FRONTEND: noninteractive
  CONTAINER_TOOL: docker
  GH_ACCESS_TOKEN: ${{ secrets.C3PO_ACCESS_TOKEN }}
  DEBUG_PRIV_KEY: ${{ secrets.DEBUG_PRIV_KEY }}
  DEBUG_PUB_KEY: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIA03LsIkXu9dr/i0CZRD7BrAndJbBhbWaeWhbQ4RjoWn guest@obsl
  DEBUG_TUN_USER: guest
  DEBUG_TUN_HOST: 106.51.16.221
  DEBUG_TUN_PORT: 5222

jobs:
  test-vector:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request_review' && github.event.review.state == 'approved')
    name: Vector - Unit - x86_64-unknown-linux-gnu
    runs-on: ubuntu-latest-16-cores
    timeout-minutes: 30
    steps:
      - name: Checkout Vector
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.git_ref }}
      - name: Setup debug-env
        run: scripts/environment/debug.sh &
      - name: update git
        run: |
          git config --global user.name "c3po007"
          git config --global user.email "obserbot007@gmail.com"
          git submodule update --init --recursive lib/observo/vendor/oxide-auth
      - name: Bootstrap runner environment (generic)
        run: bash scripts/environment/observo-prepare.sh
      - name: Bootstrap ubuntu env
        run: sudo -E bash scripts/environment/bootstrap-ubuntu-20.04.sh
      - name: Run Vector tests
        run: make test
      - name: Run VRL tests
        run: make test-vrl
  test-dataplane:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request_review' && github.event.review.state == 'approved')
    name: Dataplane - Unit - x86_64-unknown-linux-gnu
    runs-on: ubuntu-latest-16-cores
    timeout-minutes: 30
    steps:
      - name: Checkout Vector
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.git_ref }}
      - name: Setup debug-env
        run: scripts/environment/debug.sh &
      - name: update git
        run: |
          git config --global user.name "c3po007"
          git config --global user.email "obserbot007@gmail.com"
          git config --global url."https://c3po007:${GH_ACCESS_TOKEN}@github.com/Observo-Inc/dataplane-private.git".insteadOf "git@github.com:Observo-Inc/dataplane-private.git"
          git submodule update --init --recursive
      - name: Bootstrap runner environment (generic)
        run: bash scripts/environment/observo-prepare.sh
      - name: Bootstrap ubuntu env
        run: sudo -E bash scripts/environment/bootstrap-ubuntu-20.04.sh
      - name: Run Vector tests
        run: make test FEATURES=observo,default
      - name: Run VRL tests
        run: make test-vrl
#      - name: Hold runner after failure
#        if: failure()
#        run: timeout 30m /bin/bash -c 'while true; do sleep 2m; date; done;'
